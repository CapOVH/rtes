<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Casino - Blackjack, Roulette, Mines</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; margin: 0; padding: 20px; }
        h1, h2 { color: #00ff00; }
        button { padding: 10px 20px; margin: 10px; background: #00ff00; color: black; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background: #00cc00; }
        input { padding: 10px; margin: 10px; width: 200px; }
        #dashboard, #games { display: none; }
        .game-section { margin: 20px; padding: 20px; background: #1e1e1e; border-radius: 10px; }
        #mines-grid { display: grid; grid-template-columns: repeat(5, 60px); gap: 5px; margin: 20px auto; width: fit-content; }
        .tile { width: 60px; height: 60px; background: #333; border: 2px solid #555; cursor: pointer; font-size: 30px; }
        .revealed { background: #00ff00; }
        .bomb { background: red; }
        canvas { background: #000; border: 2px solid #00ff00; }
        #balance-display { font-size: 24px; color: #00ff00; margin: 20px; }
    </style>
</head>
<body>
    <h1>Virtual Casino</h1>
    <p>Play with virtual credits from your SellAuth balance!</p>

    <div id="login">
        <h2>Login with Email</h2>
        <input type="email" id="email" placeholder="your@email.com" required>
        <button onclick="login()">Login</button>
        <p><small>Top-up credits in your SellAuth shop (buy "Credit Pack" product).</small></p>
    </div>

    <div id="dashboard">
        <h2>Welcome, <span id="user-email"></span></h2>
        <div id="balance-display">Balance: Loading...</div>
        <button onclick="refreshBalance()">Refresh Balance</button>
        <button onclick="logout()">Logout</button>

        <h2>Games</h2>
        <div class="game-section">
            <button onclick="showGame('blackjack')">Play Blackjack</button>
            <button onclick="showGame('roulette')">Play Roulette</button>
            <button onclick="showGame('mines')">Play Mines</button>
        </div>
    </div>

    <!-- Games -->
    <div id="blackjack" class="game-section" style="display:none;">
        <h2>Blackjack</h2>
        <p>Bet amount: <input type="number" id="bj-bet" min="1" value="10"></p>
        <button onclick="startBlackjack()">Start Game</button>
        <div id="bj-status"></div>
        <div id="bj-player"></div>
        <div id="bj-dealer"></div>
        <button onclick="bjHit()" style="display:none;" id="bj-hit">Hit</button>
        <button onclick="bjStand()" style="display:none;" id="bj-stand">Stand</button>
        <button onclick="showGame('dashboard')">Back</button>
    </div>

    <div id="roulette" class="game-section" style="display:none;">
        <h2>Roulette (Red/Black)</h2>
        <p>Bet amount: <input type="number" id="rl-bet" min="1" value="10"></p>
        <select id="rl-choice"><option value="red">Red</option><option value="black">Black</option></select>
        <button onclick="spinRoulette()">Spin</button>
        <div id="rl-result"></div>
        <button onclick="showGame('dashboard')">Back</button>
    </div>

    <div id="mines" class="game-section" style="display:none;">
        <h2>Mines (5x5 grid, 5 mines)</h2>
        <p>Bet amount: <input type="number" id="mines-bet" min="1" value="10"></p>
        <button onclick="startMines()">Start New Game</button>
        <div id="mines-status"></div>
        <div id="mines-grid"></div>
        <button onclick="cashoutMines()" id="mines-cashout" style="display:none;">Cash Out</button>
        <button onclick="showGame('dashboard')">Back</button>
    </div>

    <script>
        let email = '';
        let balance = 0;
        let serverSeed = CryptoJS.lib.WordArray.random(32).toString(); // Simple server seed (in real: generate per round server-side)
        let clientSeed = Math.random().toString();
        let nonce = 0;

        // REPLACE THIS WITH YOUR BACKEND PROXY URL!
        const PROXY_URL = 'https://your-proxy.vercel.app/api'; // Example: create a serverless function

        async function login() {
            email = document.getElementById('email').value;
            if (!email) return alert('Enter email');
            document.getElementById('user-email').textContent = email;
            document.getElementById('login').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            await refreshBalance();
        }

        async function refreshBalance() {
            try {
                const res = await fetch(`${PROXY_URL}/balance?email=${encodeURIComponent(email)}`);
                const data = await res.json();
                balance = data.balance || 0;
                document.getElementById('balance-display').textContent = `Balance: ${balance} credits`;
            } catch (e) {
                alert('Balance fetch failed - set up backend proxy');
            }
        }

        async function updateBalance(change, desc) {
            try {
                await fetch(`${PROXY_URL}/outcome`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, amountChange: change, description: desc})
                });
                await refreshBalance();
            } catch (e) {
                alert('Balance update failed');
            }
        }

        function logout() {
            location.reload();
        }

        function showGame(game) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('blackjack').style.display = game === 'blackjack' ? 'block' : 'none';
            document.getElementById('roulette').style.display = game === 'roulette' ? 'block' : 'none';
            document.getElementById('mines').style.display = game === 'mines' ? 'block' : 'none';
        }

        // Provably Fair Helper
        function provablyRandom() {
            const hmac = CryptoJS.HmacSHA256(clientSeed + '-' + nonce, serverSeed);
            const hex = hmac.toString().substring(0, 8);
            return parseInt(hex, 16) / Math.pow(16, 8);
        }

        // Simple Blackjack
        let bjDeck, bjPlayer = [], bjDealer = [], bjBet;
        function startBlackjack() {
            bjBet = parseInt(document.getElementById('bj-bet').value);
            if (bjBet > balance) return alert('Insufficient balance');
            updateBalance(-bjBet, 'Blackjack bet');
            nonce++;
            bjDeck = generateDeck();
            bjPlayer = [drawCard(), drawCard()];
            bjDealer = [drawCard(), drawCard()];
            renderBJ();
            checkBJEnd();
        }
        function generateDeck() {
            const suits = ['â™ ','â™¥','â™¦','â™£'];
            const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            let deck = [];
            for (let s of suits) for (let r of ranks) deck.push(r + s);
            // Shuffle with provably fair
            for (let i = deck.length - 1; i > 0; i--) {
                let j = Math.floor(provablyRandom() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }
        function drawCard() { return bjDeck.pop(); }
        function cardValue(card) {
            const v = card.slice(0, -1);
            return v === 'A' ? 11 : (['J','Q','K'].includes(v) ? 10 : parseInt(v));
        }
        function handValue(hand) {
            let val = 0, aces = 0;
            for (let c of hand) {
                let v = cardValue(c);
                if (v === 11) aces++;
                val += v;
            }
            while (val > 21 && aces) { val -= 10; aces--; }
            return val;
        }
        function renderBJ() {
            document.getElementById('bj-player').textContent = 'You: ' + bjPlayer.join(' ') + ' (Value: ' + handValue(bjPlayer) + ')';
            document.getElementById('bj-dealer').textContent = 'Dealer: ' + bjDealer[0] + ' ??';
        }
        function bjHit() {
            bjPlayer.push(drawCard());
            renderBJ();
            if (handValue(bjPlayer) > 21) checkBJEnd(true);
        }
        function bjStand() {
            while (handValue(bjDealer) < 17) bjDealer.push(drawCard());
            document.getElementById('bj-dealer').textContent = 'Dealer: ' + bjDealer.join(' ') + ' (Value: ' + handValue(bjDealer) + ')';
            checkBJEnd();
        }
        function checkBJEnd(bust = false) {
            const playerVal = handValue(bjPlayer);
            const dealerVal = handValue(bjDealer);
            document.getElementById('bj-hit').style.display = 'none';
            document.getElementById('bj-stand').style.display = 'none';
            if (bust || playerVal > 21 || (dealerVal <= 21 && dealerVal > playerVal)) {
                document.getElementById('bj-status').textContent = 'You lose!';
            } else if (dealerVal > 21 || playerVal > dealerVal) {
                updateBalance(bjBet * 2, 'Blackjack win');
                document.getElementById('bj-status').textContent = 'You win!';
            } else {
                updateBalance(bjBet, 'Blackjack push');
                document.getElementById('bj-status').textContent = 'Push';
            }
            document.getElementById('bj-hit').style.display = playerVal <= 21 ? 'inline' : 'none';
            document.getElementById('bj-stand').style.display = playerVal <= 21 ? 'inline' : 'none';
        }

        // Simple Roulette (Red/Black only)
        async function spinRoulette() {
            const bet = parseInt(document.getElementById('rl-bet').value);
            const choice = document.getElementById('rl-choice').value;
            if (bet > balance) return alert('Insufficient balance');
            await updateBalance(-bet, 'Roulette bet');
            nonce++;
            const rand = provablyRandom() * 37; // 0-36
            const number = Math.floor(rand);
            const isRed = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(number);
            const color = number === 0 ? 'green' : isRed ? 'red' : 'black';
            document.getElementById('rl-result').textContent = `Ball landed on ${number} (${color})`;
            if ((choice === 'red' && isRed) || (choice === 'black' && !isRed && number !== 0)) {
                await updateBalance(bet * 2, 'Roulette win');
                document.getElementById('rl-result').textContent += ' - YOU WIN!';
            } else {
                document.getElementById('rl-result').textContent += ' - You lose';
            }
        }

        // Mines
        let minesBet, safeTiles = 0, minesRevealed = false;
        const GRID_SIZE = 25, MINES_COUNT = 5;
        let minePositions = [];
        function startMines() {
            minesBet = parseInt(document.getElementById('mines-bet').value);
            if (minesBet > balance) return alert('Insufficient balance');
            updateBalance(-minesBet, 'Mines bet');
            nonce++;
            minePositions = [];
            while (minePositions.length < MINES_COUNT) {
                let pos = Math.floor(provablyRandom() * GRID_SIZE);
                if (!minePositions.includes(pos)) minePositions.push(pos);
            }
            safeTiles = 0;
            minesRevealed = false;
            document.getElementById('mines-status').textContent = 'Safe tiles opened: 0 | Multiplier: 1x';
            document.getElementById('mines-cashout').style.display = 'inline';
            const grid = document.getElementById('mines-grid');
            grid.innerHTML = '';
            for (let i = 0; i < GRID_SIZE; i++) {
                const tile = document.createElement('div');
                tile.classList.add('tile');
                tile.onclick = () => revealTile(i, tile);
                grid.appendChild(tile);
            }
        }
        function revealTile(pos, tile) {
            if (minesRevealed || tile.classList.contains('revealed')) return;
            tile.classList.add('revealed');
            if (minePositions.includes(pos)) {
                tile.textContent = 'ðŸ’£';
                tile.classList.add('bomb');
                minesRevealed = true;
                document.getElementById('mines-status').textContent = 'BOOM! You lose.';
                document.getElementById('mines-cashout').style.display = 'none';
                revealAllMines();
            } else {
                tile.textContent = 'ðŸ’Ž';
                safeTiles++;
                const multiplier = (safeTiles + 1); // Simple multiplier
                document.getElementById('mines-status').textContent = `Safe: ${safeTiles} | Multiplier: ${multiplier}x`;
            }
        }
        function cashoutMines() {
            if (minesRevealed) return;
            const win = minesBet * (safeTiles + 1);
            updateBalance(win, 'Mines cashout');
            document.getElementById('mines-status').textContent += ` - Cashed out ${win} credits!`;
            document.getElementById('mines-cashout').style.display = 'none';
            revealAllMines();
        }
        function revealAllMines() {
            const tiles = document.querySelectorAll('#mines-grid .tile');
            minePositions.forEach(p => {
                tiles[p].textContent = 'ðŸ’£';
                tiles[p].classList.add('bomb');
            });
        }
    </script>
</body>
</html>
